<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ç°¡æ˜“ç²¾ç®—</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background-color: #fcfcfc; color: #333; font-family: sans-serif; }
    .container { max-width: 600px; margin-top: 20px; margin-bottom: 60px; }
    .card { border: none; box-shadow: 0 4px 15px rgba(0,0,0,0.05); border-radius: 12px; }
    #loading { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #fff; z-index: 9999; display: flex; align-items: center; justify-content: center; flex-direction: column; }
    .fw-bold-label { font-size: 0.85rem; font-weight: bold; }
    
    /* æ¹§ãå‡ºã—ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ç”¨ */
    .other-row {
      animation: fadeIn 0.3s ease-out;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-5px); }
      to { opacity: 1; transform: translateY(0); }
    }
  </style>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body>

<div id="loading">
  <div class="spinner-border text-success mb-2" role="status"></div>
  <div class="small text-muted">èª­ã¿è¾¼ã¿ä¸­...</div>
</div>

<div id="mainView" class="d-none">
  <div class="container">
    <!-- ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
    <div class="mb-3">
      <a href="index.html" class="text-decoration-none text-secondary fw-bold">&lt; ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«æˆ»ã‚‹</a>
    </div>

    <div class="card">
      <div class="card-body">
        <h5 class="card-title text-center text-success mb-3 fw-bold">ç°¡æ˜“ç²¾ç®—ãƒ•ã‚©ãƒ¼ãƒ </h5>
        <form id="settlementForm">
          
          <!-- è¡Œãå…ˆ -->
          <div class="mb-4">
            <label class="form-label fw-bold-label">æ—…è¡Œã®è¡Œãå…ˆ</label>
            <input type="text" class="form-control" id="destination" placeholder="ä¾‹ï¼šç®±æ ¹æ¸©æ³‰">
          </div>

          <!-- å›ºå®šé …ç›® -->
          <div class="row g-2 mb-3">
            <div class="col-6"><label class="fw-bold-label">ãƒ¬ãƒ³ã‚¿ã‚«ãƒ¼</label><input type="number" class="form-control amount-input" id="rentalCar" placeholder="0" min="0"></div>
            <div class="col-6"><label class="fw-bold-label">é«˜é€Ÿä»£</label><input type="number" class="form-control amount-input" id="highway" placeholder="0" min="0"></div>
          </div>
          <div class="row g-2 mb-3">
            <div class="col-6"><label class="fw-bold-label">å®¿æ³Šä»£</label><input type="number" class="form-control amount-input" id="accommodation" placeholder="0" min="0"></div>
            <div class="col-6"><label class="fw-bold-label">é§è»Šå ´</label><input type="number" class="form-control amount-input" id="parking" placeholder="0" min="0"></div>
          </div>

          <!-- ã‚¬ã‚½ãƒªãƒ³è¨ˆç®— (çµŒè·¯æ¤œç´¢ãƒœã‚¿ãƒ³è¿½åŠ ) -->
          <div class="mb-3 p-2 bg-light rounded">
            <div class="d-flex justify-content-between align-items-center mb-1">
              <label class="fw-bold-label mb-0">ã‚¬ã‚½ãƒªãƒ³ (è·é›¢/ç‡ƒè²»/å˜ä¾¡)</label>
              <button type="button" class="btn btn-sm btn-outline-primary py-0" style="font-size: 0.7rem;" onclick="openRouteModal()">ğŸ“ çµŒè·¯æ¤œç´¢</button>
            </div>
            <div class="input-group input-group-sm mt-1">
              <input type="number" class="form-control gas-calc" id="dist" placeholder="km" min="0" step="0.1">
              <input type="number" class="form-control gas-calc" id="eff" placeholder="km/L" min="0" step="0.1">
              <input type="number" class="form-control gas-calc" id="price" placeholder="å††" min="0">
            </div>
            <input type="number" class="form-control amount-input mt-2 fw-bold" id="gasTotal" readonly placeholder="åˆè¨ˆ" value="0">
          </div>

          <!-- ãã®ä»–é …ç›®ï¼ˆç„¡é™æ¹§ãå‡ºã—ã‚³ãƒ³ãƒ†ãƒŠï¼‰ -->
          <div id="otherItemsContainer">
            <!-- JSã§å‹•çš„ã«è¿½åŠ ã•ã‚Œã¾ã™ -->
          </div>

          <!-- äººæ•°é¸æŠ -->
          <div class="mb-3 mt-4">
            <label for="splitCount" class="form-label fw-bold-label">ä½•äººã§å‰²ã‚Šã¾ã™ã‹ï¼Ÿ</label>
            <select class="form-select" id="splitCount">
              <option value="1">1äºº</option>
              <option value="2" selected>2äºº</option>
              <option value="3">3äºº</option>
              <option value="4">4äºº</option>
            </select>
          </div>

          <!-- åˆè¨ˆè¡¨ç¤º -->
          <div class="alert alert-secondary py-2 mb-3">
            <div class="fw-bold">ç·é¡: Â¥<span id="grandTotal">0</span></div>
            <div class="small">1äºº: Â¥<span id="perPersonTotal">0</span></div>
          </div>

          <!-- é€ä¿¡ãƒœã‚¿ãƒ³ -->
          <button type="button" class="btn btn-success w-100 py-3 fw-bold" id="sendBtn" onclick="onSend()">
            å‹ã ã¡ã‚’é¸ã‚“ã§é€ä¿¡
          </button>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- ==========================================
     è¿½åŠ UI: çµŒè·¯æ¤œç´¢ãƒ¢ãƒ¼ãƒ€ãƒ«
=========================================== -->
<div class="modal fade" id="routeModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0 shadow">
      <div class="modal-header bg-light py-2">
        <h5 class="modal-title fw-bold fs-6">ğŸ“ çµŒè·¯ã‹ã‚‰è·é›¢ã‚’èª¿ã¹ã‚‹</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="input-group input-group-sm mb-2">
          <button class="btn btn-outline-secondary" type="button" onclick="getCurrentLocation()" id="btnLocation">ç¾åœ¨åœ°</button>
          <input type="text" class="form-control" id="routeOrigin" placeholder="å‡ºç™ºåœ° (ä½æ‰€ã‚„æ–½è¨­å)">
        </div>
        <div class="input-group input-group-sm mb-1">
          <span class="input-group-text">è¡Œå…ˆ</span>
          <input type="text" class="form-control" id="routeDest" placeholder="ä¾‹: é‡æ²¢æ¸©æ³‰ã‚¹ã‚­ãƒ¼å ´">
          <button class="btn btn-secondary fw-bold" type="button" onclick="searchRoute()" id="btnSearchRoute">æ¤œç´¢</button>
        </div>
        
        <div id="routeResultArea" class="d-none mt-3 p-2 bg-light border rounded">
          <div id="routeLoading" class="d-none text-center text-muted small py-1">æ¤œç´¢ä¸­...</div>
          <div id="routeData" class="d-none">
            <div class="text-center mb-1">
              <span class="small text-muted">ãƒ«ãƒ¼ãƒˆè·é›¢: </span>
              <strong class="text-primary fs-5" id="resDist">0</strong> <span class="text-primary fw-bold">km</span>
            </div>
            <div class="text-muted bg-white p-1 rounded border mb-2" style="font-size: 0.65rem; line-height: 1.2;">
              èªè­˜ã•ã‚ŒãŸç›®çš„åœ°:<br><span id="resAddress" class="fw-bold text-dark"></span>
            </div>
            <div class="d-flex gap-2">
              <button type="button" class="btn btn-outline-primary btn-sm flex-grow-1 py-1" onclick="applyDistance(1)">â¡ï¸ ç‰‡é“ã§åæ˜ </button>
              <button type="button" class="btn btn-outline-primary btn-sm flex-grow-1 py-1" onclick="applyDistance(2)">â†”ï¸ å¾€å¾©ã§åæ˜ </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
  // ==========================================
  // è¨­å®šã‚»ã‚¯ã‚·ãƒ§ãƒ³
  // ==========================================
  const CONFIG = {
    LIFF_ID: "2008842942-XFy8Tty3",
    GAS_URL: "https://script.google.com/macros/s/AKfycbxK0YaFYVlqwa0F_foz-2WlguFEyrpry1dvKJ6vmDGdPkpWlfDsaWb9vQuaiHdRMC1n/exec"
  };

  let userProfile = { displayName: "ä¸æ˜", userId: "" };
  let otherRowCount = 0; // ä»–é …ç›®ã®ç¾åœ¨ã®è¡Œæ•°
  let routeModalInstance = null;
  let tempRouteDistance = 0;

  // ==========================================
  // åˆæœŸåŒ–
  // ==========================================
  window.onload = function() {
    // æœ€åˆã®3è¡Œã‚’ç”Ÿæˆ
    addOtherRow();
    addOtherRow();
    addOtherRow();

    liff.init({ liffId: CONFIG.LIFF_ID }).then(() => {
      if (!liff.isLoggedIn()) {
        liff.login();
      } else {
        liff.getProfile().then(profile => {
          userProfile.displayName = profile.displayName;
          userProfile.userId = profile.userId;
        });
        document.getElementById('loading').classList.add('d-none');
        document.getElementById('mainView').classList.remove('d-none');
      }
    });
  };

  // ==========================================
  // ç„¡é™æ¹§ãå‡ºã—ãƒ­ã‚¸ãƒƒã‚¯ (ä»–é …ç›®)
  // ==========================================
  function addOtherRow() {
    otherRowCount++;
    const container = document.getElementById('otherItemsContainer');
    const div = document.createElement('div');
    div.className = "input-group input-group-sm mb-2 other-row";
    div.innerHTML = `
      <span class="input-group-text">ä»–${otherRowCount}</span>
      <input type="text" class="form-control item-name" placeholder="é …ç›®å">
      <input type="number" class="form-control amount-input" placeholder="0" min="0">
    `;
    container.appendChild(div);
  }

  // å…¥åŠ›ãŒå¤‰æ›´ã•ã‚Œã‚‹ãŸã³ã«ã‚¤ãƒ™ãƒ³ãƒˆç™ºç«
  document.addEventListener('input', function(e) {
    calculateTotal(); // å…¨ä½“ã®è¨ˆç®—ã‚’æ›´æ–°

    // ã€Œä»–é …ç›®ã€ã®é‡‘é¡æ¬„ã«å…¥åŠ›ã•ã‚ŒãŸå ´åˆã®ç„¡é™æ¹§ãå‡ºã—åˆ¤å®š
    if (e.target && e.target.classList.contains('amount-input') && e.target.closest('.other-row')) {
      const allRows = document.querySelectorAll('.other-row');
      const lastRow = allRows[allRows.length - 1];
      // ç·¨é›†ã•ã‚ŒãŸã®ãŒã€Œä¸€ç•ªæœ€å¾Œã®è¡Œã€ã§ã€ã‹ã¤ã€Œå€¤ãŒå…¥ã£ã¦ã„ã‚‹ã€å ´åˆã€æ¬¡ã®è¡Œã‚’è¿½åŠ 
      if (e.target === lastRow.querySelector('.amount-input') && e.target.value !== "") {
        addOtherRow();
      }
    }
  });

  function calculateTotal() {
    // 1. ã‚¬ã‚½ãƒªãƒ³ä»£ã®è¨ˆç®—
    const d = parseFloat(document.getElementById('dist').value) || 0;
    const e = parseFloat(document.getElementById('eff').value) || 0;
    const p = parseFloat(document.getElementById('price').value) || 0;
    
    const gas = (e > 0) ? Math.floor((d / e) * p) : 0;
    document.getElementById('gasTotal').value = gas;

    // 2. å…¨é …ç›®ã®åˆè¨ˆè¨ˆç®—
    let sum = 0;
    document.querySelectorAll('.amount-input').forEach(el => {
      let val = parseInt(el.value) || 0;
      if (val < 0) val = 0;
      sum += val;
    });

    const split = parseInt(document.getElementById('splitCount').value);
    
    // è¡¨ç¤ºæ›´æ–°
    document.getElementById('grandTotal').innerText = sum.toLocaleString();
    document.getElementById('perPersonTotal').innerText = Math.ceil(sum / split).toLocaleString();
  }

  // ==========================================
  // â˜…çµŒè·¯æ¤œç´¢ãƒ­ã‚¸ãƒƒã‚¯ (ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—)
  // ==========================================
  function openRouteModal() {
    document.getElementById('routeOrigin').value = '';
    document.getElementById('routeDest').value = '';
    document.getElementById('routeResultArea').classList.add('d-none');
    
    if (!routeModalInstance) {
        routeModalInstance = new bootstrap.Modal(document.getElementById('routeModal'));
    }
    routeModalInstance.show();
  }

  function getCurrentLocation() {
    const btn = document.getElementById('btnLocation');
    const originInput = document.getElementById('routeOrigin');
    
    btn.disabled = true; originInput.value = "å–å¾—ä¸­..."; originInput.disabled = true;

    if (!navigator.geolocation) {
      alert("ä½ç½®æƒ…å ±ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ã€‚");
      originInput.value = ""; originInput.disabled = false; btn.disabled = false; return;
    }

    navigator.geolocation.getCurrentPosition(
      (pos) => {
        originInput.value = `${pos.coords.latitude},${pos.coords.longitude}`;
        originInput.disabled = false; btn.disabled = false;
      },
      (err) => {
        alert("ä½ç½®æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚æ‰‹å‹•ã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
        originInput.value = ""; originInput.disabled = false; btn.disabled = false;
      },
      { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
    );
  }

  async function searchRoute() {
    const origin = document.getElementById('routeOrigin').value.trim();
    const dest = document.getElementById('routeDest').value.trim();

    if (!origin || !dest) return alert("å‡ºç™ºåœ°ã¨è¡Œå…ˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");

    const resultArea = document.getElementById('routeResultArea');
    const routeLoading = document.getElementById('routeLoading');
    const routeData = document.getElementById('routeData');
    const btnSearch = document.getElementById('btnSearchRoute');

    resultArea.classList.remove('d-none'); routeLoading.classList.remove('d-none');
    routeData.classList.add('d-none'); btnSearch.disabled = true;

    try {
      const response = await fetch(CONFIG.GAS_URL, {
        method: "POST", headers: { "Content-Type": "text/plain" },
        body: JSON.stringify({ action: 'calc_distance', origin: origin, destination: dest })
      });
      const data = await response.json();

      if (data.result === 'success') {
        tempRouteDistance = parseFloat(data.data.distance);
        document.getElementById('resDist').innerText = data.data.distance;
        document.getElementById('resAddress').innerText = data.data.address;
        routeLoading.classList.add('d-none'); routeData.classList.remove('d-none');
      } else {
        alert("æ¤œç´¢ã‚¨ãƒ©ãƒ¼:\n" + data.message); resultArea.classList.add('d-none');
      }
    } catch (e) {
      alert("é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ"); resultArea.classList.add('d-none');
    } finally {
      btnSearch.disabled = false;
    }
  }

  function applyDistance(multiplier) {
    if (tempRouteDistance > 0) {
      const finalDist = (tempRouteDistance * multiplier).toFixed(1);
      document.getElementById('dist').value = finalDist;
      calculateTotal(); // è·é›¢ã‚’ã‚»ãƒƒãƒˆã—ãŸã‚‰å†è¨ˆç®—
      
      if (routeModalInstance) routeModalInstance.hide();
    }
  }

  // ==========================================
  // é€ä¿¡å‡¦ç†
  // ==========================================
  function onSend() {
    if (!liff.isLoggedIn()) return alert("å†ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„");
    if (!CONFIG.GAS_URL) return alert("ã‚·ã‚¹ãƒ†ãƒ ã‚¨ãƒ©ãƒ¼: GAS_URLãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“");

    const btn = document.getElementById('sendBtn');
    
    // äºŒé‡é€ä¿¡é˜²æ­¢
    btn.disabled = true; 
    btn.innerText = "å‡¦ç†ä¸­..."; 
    
    const destination = document.getElementById('destination').value || "æœªå…¥åŠ›";
    const totalAmountStr = document.getElementById('grandTotal').innerText.replace(/,/g, '');
    const totalAmount = parseInt(totalAmountStr) || 0;
    const splitCount = document.getElementById('splitCount').value;
    const perPerson = document.getElementById('perPersonTotal').innerText;

    let msg = `ã€ç°¡æ˜“ç²¾ç®—: ${destination}ã€‘\n`;
    let detailText = ""; 
    let jsonData = { basic: {}, gas: {}, others: [] };

    const addBasic = (id, name, key) => {
      const v = parseInt(document.getElementById(id).value) || 0;
      if (v > 0) {
        msg += `\nâ– ${name}: Â¥${v.toLocaleString()}`;
        detailText += `ãƒ»${name}: ${v}å††\n`;
        jsonData.basic[key] = v;
      }
    };

    addBasic('rentalCar', 'ãƒ¬ãƒ³ã‚¿ã‚«ãƒ¼', 'rental');
    addBasic('highway', 'é«˜é€Ÿ', 'highway');
    addBasic('accommodation', 'å®¿æ³Š', 'accommodation');
    addBasic('parking', 'é§è»Šå ´', 'parking');
    
    const gas = parseInt(document.getElementById('gasTotal').value) || 0;
    if(gas > 0) {
      const d = document.getElementById('dist').value;
      const e = document.getElementById('eff').value;
      const p = document.getElementById('price').value;
      const info = `(${d}km / ${e}km/L / @${p}å††)`;
      msg += `\nâ– ã‚¬ã‚½ãƒªãƒ³: Â¥${gas.toLocaleString()}\n${info}`;
      detailText += `ãƒ»ã‚¬ã‚½ãƒªãƒ³: ${gas}å†† ${info}\n`;
      jsonData.gas = { amount: gas, dist: d, eff: e, price: p };
    }
    
    // ãã®ä»–é …ç›® (å‹•çš„ã«ç”Ÿæˆã•ã‚ŒãŸè¡Œã‚’ã™ã¹ã¦å–å¾—)
    document.querySelectorAll('.other-row').forEach(row => {
      const name = row.querySelector('.item-name').value || 'ãã®ä»–';
      const val = parseInt(row.querySelector('.amount-input').value) || 0;
      if (val > 0) {
        const line = `â– ${name}: Â¥${val.toLocaleString()}`;
        msg += `\n${line}`;
        detailText += `ãƒ»${name}: ${val}å††\n`;
        jsonData.others.push({ item: name, amount: val });
      }
    });

    const summary = `ç·é¡: Â¥${totalAmount.toLocaleString()} (1äºº: Â¥${perPerson})`;
    msg += `\n\n${summary}`;
    msg += `\n\n----------------\nâ–¼ã“ã®Botã‚’å‹ã ã¡è¿½åŠ \nhttps://lin.ee/A8jCBxs`; 

    const logData = {
      type: "ç°¡æ˜“ç²¾ç®—", user: userProfile.displayName, userId: userProfile.userId,
      destination: destination, total: totalAmount, count: splitCount,
      summary: summary, textDetail: detailText, jsonDetail: JSON.stringify(jsonData)
    };
    
    fetch(CONFIG.GAS_URL, {
      method: "POST", mode: "no-cors", headers: { "Content-Type": "application/json" }, body: JSON.stringify(logData)
    }).catch(e => console.error("Log send error:", e));

    if (liff.isApiAvailable('shareTargetPicker')) {
      liff.shareTargetPicker([{ type: "text", text: msg }])
      .then((res) => {
        if (res) { alert("é€ä¿¡ã—ã¾ã—ãŸï¼"); liff.closeWindow(); } 
        else { alert("ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸ"); btn.disabled = false; btn.innerText = "å‹ã ã¡ã‚’é¸ã‚“ã§é€ä¿¡"; }
      }).catch(err => {
        alert("é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ"); btn.disabled = false; btn.innerText = "å‹ã ã¡ã‚’é¸ã‚“ã§é€ä¿¡";
      });
    } else {
      liff.sendMessages([{ type: 'text', text: msg }])
      .then(() => { alert("Botã¨ã®ãƒˆãƒ¼ã‚¯ãƒ«ãƒ¼ãƒ ã«é€ä¿¡ã—ã¾ã—ãŸã€‚"); liff.closeWindow(); })
      .catch((err) => { alert("é€ä¿¡ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚"); btn.disabled = false; btn.innerText = "å‹ã ã¡ã‚’é¸ã‚“ã§é€ä¿¡"; });
    }
  }
</script>
</body>
</html>
